<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fable Tactics – Party Selector</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@500;600;700&family=Cormorant+Garamond:wght@400;500;600&display=swap');
    :root {
      --bg:#120d07;
      --bg-accent:#1d1409;
      --parchment:#f4e7cb;
      --parchment-deep:#e6d4aa;
      --ink:#2f1c0f;
      --ink-soft:#4a2b17;
      --muted:#8c7358;
      --muted-strong:#5b3d24;
      --accent:#c39a3d;
      --accent-strong:#e1c269;
      --accent-soft:rgba(195,154,61,.22);
      --panel-border:#d8bc85;
      --panel-shadow:rgba(9,5,2,.45);
      --ally:#6d9348;
      --enemy:#b55252;
    }
    * { box-sizing:border-box; font-family:'Cormorant Garamond', 'Times New Roman', serif; }
    body {
      margin:0;
      min-height:100vh;
      color:var(--ink);
      background:
        radial-gradient(circle at 18% 8%, rgba(195,154,61,.18) 0%, transparent 44%),
        radial-gradient(circle at 82% 0%, rgba(138,92,38,.25) 0%, transparent 52%),
        linear-gradient(180deg, #1a1209 0%, #130c06 55%, #1d1408 100%);
      position:relative;
      overflow-x:hidden;
    }
    body::before {
      content:"";
      position:fixed;
      inset:-160px;
      background:
        radial-gradient(rgba(255,244,214,.08) 1px, transparent 1px),
        repeating-linear-gradient(125deg, rgba(90,58,26,.05) 0 16px, transparent 16px 32px);
      background-size:120px 120px, 240px 240px;
      opacity:.45;
      pointer-events:none;
      mix-blend-mode:screen;
      z-index:-2;
    }
    header {
      padding:18px 24px;
      border-bottom:2px solid rgba(195,154,61,.35);
      background:linear-gradient(135deg, rgba(67,41,19,.95), rgba(40,23,11,.95));
      position:sticky;
      top:0;
      z-index:6;
      display:flex;
      align-items:center;
      gap:18px;
      flex-wrap:wrap;
      box-shadow:0 14px 22px rgba(7,4,2,.45);
    }
    header h1 {
      margin:0;
      font-family:'Cinzel','Cormorant Garamond',serif;
      font-size:20px;
      letter-spacing:.28em;
      text-transform:uppercase;
      color:var(--accent-strong);
      flex:1 0 auto;
    }
    header nav {
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    header nav .nav-btn {
      color:var(--muted-strong);
      text-decoration:none;
      font-size:12px;
      letter-spacing:.22em;
      text-transform:uppercase;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid rgba(195,154,61,.45);
      background:linear-gradient(180deg, rgba(245,231,197,.92), rgba(228,206,162,.88));
      box-shadow:0 6px 14px rgba(12,6,2,.35);
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease, color .18s ease;
    }
    header nav .nav-btn:hover {
      transform:translateY(-1px);
      color:var(--ink);
      border-color:rgba(225,193,112,.75);
      box-shadow:0 10px 18px rgba(10,5,2,.45);
    }
    header nav .nav-btn.active {
      color:var(--ink);
      border-color:rgba(225,193,112,.9);
      box-shadow:0 0 0 2px rgba(225,193,112,.3), 0 12px 20px rgba(12,5,2,.45);
    }
    main {
      max-width:1100px;
      margin:0 auto;
      padding:28px 24px 56px;
      display:grid;
      gap:20px;
      grid-template-columns: 1fr 1fr;
      position:relative;
    }
    main::before {
      content:"";
      position:absolute;
      inset:0;
      border-radius:28px;
      background:
        radial-gradient(circle at 14% 10%, rgba(225,193,112,.25), transparent 58%),
        radial-gradient(circle at 86% 20%, rgba(124,93,42,.18), transparent 60%);
      opacity:.6;
      z-index:-1;
    }
    .panel {
      background:linear-gradient(180deg, rgba(245,231,197,.96), rgba(228,209,172,.95));
      border:1px solid var(--panel-border);
      border-radius:18px;
      padding:22px;
      box-shadow:0 24px 40px var(--panel-shadow);
      position:relative;
      overflow:hidden;
    }
    .panel::before {
      content:"";
      position:absolute;
      inset:1px;
      border-radius:16px;
      background:linear-gradient(160deg, rgba(255,255,255,.58), rgba(243,226,191,.82));
      mix-blend-mode:multiply;
      opacity:.45;
      z-index:-1;
    }
    .panel::after {
      content:"";
      position:absolute;
      inset:auto -24% -48%;
      height:72%;
      background:radial-gradient(circle, rgba(195,154,61,.28) 0%, transparent 68%);
      opacity:0;
      transition:opacity .35s ease;
      pointer-events:none;
    }
    .panel:hover::after { opacity:.75; }
    h2 {
      margin:0 0 12px;
      font-size:14px;
      letter-spacing:.28em;
      text-transform:uppercase;
      color:var(--muted);
      font-family:'Cinzel','Cormorant Garamond',serif;
    }
    h2::after {
      content:"";
      display:block;
      margin-top:8px;
      width:52px;
      height:2px;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(195,154,61,.6), transparent);
    }
    p { line-height:1.6; }
    label { font-size:12px; color:var(--muted-strong); letter-spacing:.05em; display:flex; flex-direction:column; gap:6px; }
    .row { display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end; }
    .col { display:flex; flex-direction:column; gap:6px; min-width:140px; flex:1; }
    input[type="text"], input[type="number"], select, textarea {
      padding:9px 12px;
      background:rgba(248,235,208,.92);
      color:var(--ink);
      border:1px solid rgba(195,154,61,.55);
      border-radius:10px;
      box-shadow:inset 0 2px 6px rgba(0,0,0,.12);
      font-size:13px;
      transition:border-color .18s ease, box-shadow .18s ease;
    }
    input[type="number"] { width:92px; }
    input[type="range"] { accent-color:var(--accent); }
    input[type="text"]:focus-visible,
    input[type="number"]:focus-visible,
    textarea:focus-visible,
    select:focus-visible {
      outline:none;
      border-color:rgba(225,193,112,.85);
      box-shadow:0 0 0 1px rgba(225,193,112,.35), 0 10px 20px rgba(86,62,28,.3);
    }
    select {
      appearance:none;
      padding-right:36px;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 8"><path fill="%23c39a3d" d="M1.3.7 6 5.4 10.7.7 12 2 6 8 0 2z"/></svg>');
      background-repeat:no-repeat;
      background-size:14px 10px;
      background-position:right 12px center;
    }
    textarea { min-height:96px; }

    button {
      background:linear-gradient(180deg, rgba(133,88,36,.92), rgba(92,57,24,.9));
      color:#fdf7e3;
      border:1px solid rgba(141,99,40,.6);
      padding:10px 16px;
      border-radius:11px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
      position:relative;
      overflow:hidden;
    }
    button::after {
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(135deg, rgba(225,193,112,.28), transparent 60%);
      opacity:0;
      transition:opacity .2s ease;
      pointer-events:none;
    }
    button:hover {
      border-color:rgba(225,193,112,.75);
      transform:translateY(-1px);
      box-shadow:0 12px 22px rgba(20,10,4,.35);
    }
    button:hover::after { opacity:.55; }
    button.primary {
      background:linear-gradient(180deg, rgba(195,154,61,.95), rgba(150,101,32,.92));
      border-color:rgba(225,193,112,.75);
      color:#2f1c0f;
    }
    button.ghost {
      background:linear-gradient(180deg, rgba(248,235,205,.88), rgba(231,210,172,.86));
      border-color:rgba(195,154,61,.55);
      color:var(--ink-soft);
    }
    button.warn {
      background:linear-gradient(180deg, rgba(138,50,40,.9), rgba(102,36,28,.9));
      border-color:rgba(166,64,54,.7);
    }
    button:disabled { opacity:.6; cursor:not-allowed; box-shadow:none; transform:none; }
    button:disabled::after { display:none; }
    .footer { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .notice { font-size:12px; color:var(--muted); }
    code { background:rgba(248,235,205,.85); padding:2px 6px; border-radius:6px; border:1px solid rgba(195,154,61,.45); }

    .lists { display:grid; gap:18px; grid-template-columns: 1fr 1fr; }
    #allyList, #enemyList { display:flex; flex-direction:column; gap:10px; }
    .unitCard {
      position:relative;
      display:grid;
      grid-template-columns: 64px 1fr auto;
      gap:14px;
      align-items:center;
      padding:12px 14px;
      background:linear-gradient(120deg, rgba(248,235,208,.92), rgba(232,210,176,.9));
      border:1px solid rgba(195,154,61,.55);
      border-radius:12px;
      box-shadow:0 12px 24px rgba(12,6,3,.28);
    }
    .unitCard::after {
      content:"";
      position:absolute;
      inset:auto 18px -6px;
      height:1px;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(195,154,61,.4), transparent 70%);
      opacity:.4;
      pointer-events:none;
    }
    .sprite {
      width:64px;
      height:64px;
      border-radius:12px;
      background:rgba(195,154,61,.18);
      background-size:cover;
      background-position:center;
      border:1px solid rgba(141,99,40,.45);
      box-shadow:0 10px 20px rgba(12,6,3,.28);
    }
    #preview { width:96px; height:96px; border-radius:16px; border:1px solid rgba(141,99,40,.5); box-shadow:0 14px 28px rgba(12,6,3,.32); background-size:cover; background-position:center; margin-top:10px; }
    .name { font-weight:700; font-size:15px; color:var(--ink-soft); }
    .meta { font-size:12px; color:var(--muted); display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
    .meta .metaClass { color:var(--accent); font-weight:600; }
    .meta .pos { padding:2px 6px; border-radius:6px; background:rgba(248,235,205,.85); border:1px solid rgba(195,154,61,.45); font-size:11px; letter-spacing:.03em; }
    .pill { font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid rgba(195,154,61,.45); background:rgba(248,235,205,.85); color:var(--muted-strong); }

    .classInfo {
      margin-top:12px;
      padding:12px;
      border-radius:10px;
      background:rgba(248,235,205,.9);
      border:1px solid rgba(195,154,61,.45);
      box-shadow:inset 0 2px 8px rgba(0,0,0,.12);
      line-height:1.6;
    }
    .classInfo strong { color:var(--ink-soft); }
    .classFilters { display:flex; gap:8px; flex-wrap:wrap; margin:14px 0; }
    .classFilters .filterBtn {
      padding:6px 12px;
      font-size:12px;
      border-radius:999px;
      background:rgba(248,235,205,.85);
      border:1px solid rgba(195,154,61,.45);
      box-shadow:0 4px 10px rgba(0,0,0,.18);
      transition:all .18s ease;
    }
    .classFilters .filterBtn.active {
      border-color:rgba(133,168,96,.65);
      color:var(--ally);
      box-shadow:0 0 12px rgba(133,168,96,.28);
    }

    .classGrid { display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); }
    .classGridEmpty {
      grid-column:1 / -1;
      padding:12px;
      border-radius:10px;
      background:rgba(248,235,205,.85);
      border:1px solid rgba(195,154,61,.45);
      text-align:center;
      color:var(--muted);
    }
    .classTile {
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding:12px 14px;
      border-radius:14px;
      background:linear-gradient(130deg, rgba(248,235,208,.94), rgba(233,210,171,.92));
      border:1px solid rgba(195,154,61,.5);
      box-shadow:0 12px 24px rgba(12,6,3,.25);
      text-align:left;
      cursor:pointer;
      transition:transform .16s ease, box-shadow .16s ease, border-color .16s ease;
    }
    .classTile:hover {
      transform:translateY(-2px);
      box-shadow:0 18px 28px rgba(12,6,3,.32);
      border-color:rgba(225,193,112,.75);
    }
    .classTile.selected {
      border-color:rgba(133,168,96,.7);
      box-shadow:0 0 0 2px rgba(133,168,96,.28), 0 18px 30px rgba(62,82,40,.35);
    }
    .classTile .thumb {
      width:64px;
      height:64px;
      border-radius:12px;
      background:rgba(195,154,61,.18);
      background-size:cover;
      background-position:center;
      border:1px solid rgba(141,99,40,.45);
      box-shadow:0 10px 18px rgba(12,6,3,.28);
      flex-shrink:0;
    }
    .classTile .details { flex:1; display:flex; flex-direction:column; gap:6px; }
    .classTile .title { font-weight:600; font-size:14px; color:var(--ink-soft); letter-spacing:.02em; }
    .classTile .desc { font-size:12px; color:var(--muted); line-height:1.5; }

    .badge { font-size:11px; letter-spacing:.2em; text-transform:uppercase; color:var(--ink); background:rgba(225,193,112,.3); border:1px solid rgba(225,193,112,.6); border-radius:999px; padding:4px 10px; }
    .badge.ally { color:var(--ally); border-color:rgba(133,168,96,.55); background:rgba(226,240,204,.6); }
    .badge.enemy { color:var(--enemy); border-color:rgba(180,88,82,.55); background:rgba(244,214,206,.6); }

    @media (max-width: 960px) {
      main { grid-template-columns:1fr; padding:24px 20px 52px; }
      .lists { grid-template-columns:1fr; }
    }
    @media (max-width: 720px) {
      header { padding:16px 18px; }
      header h1 { flex:1 0 100%; text-align:center; }
      header nav { width:100%; justify-content:center; gap:8px; }
      header nav .nav-btn { padding:7px 12px; letter-spacing:.18em; }
      main { padding:20px 16px 46px; gap:18px; }
      .panel { padding:18px; }
    }
  </style>

</head>
<body>
  <header>
    <h1>Fable Tactics – Party Selector</h1>
    <nav>
      <a href="start.html" class="nav-btn">Start</a>
      <a href="game-setup.html" class="nav-btn">Game Setup</a>
      <a href="selector.html" class="nav-btn active">Party Builder</a>
      <a href="combat-sim.html" class="nav-btn">Combat Sim</a>
      <a href="quickstart.html" class="nav-btn">Quick Start</a>
      <a href="board-builder.html" class="nav-btn">Map Builder</a>
      <a href="unit-icons.html" class="nav-btn">Unit Icons</a>
    </nav>
  </header>
  <main>
    <section class="panel">
      <h2>Build Unit</h2>
      <div class="small">Pick a class, edit name (optional), choose a team, and (optionally) set a starting X/Y. Click <b>Add</b> to queue it.</div>
      <div class="sep"></div>
      <div class="row">
        <div class="col">
          <label>Class</label>
          <select id="classSel"></select>
        </div>
        <div class="col">
          <label>Name (optional)</label>
          <input id="nameInput" type="text" placeholder="auto from class">
        </div>
        <div class="col">
          <label>Team</label>
          <select id="teamSel">
            <option value="ally">Allies</option>
            <option value="enemy">Enemies</option>
          </select>
        </div>
        <div class="col">
          <label>Start X (optional)</label>
          <input id="xInput" type="number" min="0" value="">
        </div>
        <div class="col">
          <label>Start Y (optional)</label>
          <input id="yInput" type="number" min="0" value="">
        </div>
        <div class="col">
          <button id="addBtn" class="primary">Add</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="small">Sprite preview</div>
      <div id="preview" class="sprite"></div>
      <div id="classInfo" class="classInfo small"></div>
    </section>

    <section class="panel" style="grid-column: 1 / -1;">
      <h2>Class Browser</h2>
      <div class="small">Browse every class in the roster, filter by attunement type or battlefield role category, and click a tile to select it instantly.</div>
      <div id="classFilters" class="classFilters">
        <button class="filterBtn active" data-filter="all">All</button>
        <button class="filterBtn" data-filter="martial">Martial (No Attune)</button>
        <button class="filterBtn" data-filter="fae">Fae Attuned</button>
        <button class="filterBtn" data-filter="dream">Dream Attuned</button>
        <button class="filterBtn" data-filter="hybrid">Hybrid</button>
        <button class="filterBtn" data-filter="combat">Combat Units</button>
        <button class="filterBtn" data-filter="support">Support Units</button>
        <button class="filterBtn" data-filter="utility">Utility Units</button>
      </div>
      <div id="classGrid" class="classGrid"></div>
    </section>

    <section class="panel">
      <h2>Settings (Optional)</h2>
      <div class="row">
        <div class="col">
          <label>Default Grid Width (for guidance)</label>
          <input id="gridW" type="number" min="4" max="16" value="8">
        </div>
        <div class="col">
          <label>Default Grid Height</label>
          <input id="gridH" type="number" min="3" max="12" value="6">
        </div>
      </div>
      <div class="sep"></div>
      <div class="footer">
        <button id="saveBtn" class="primary">Save to Browser</button>
        <button id="loadBtn" class="ghost">Load Existing</button>
        <button id="clearBtn" class="warn">Clear All</button>
        <span class="notice">Saved as <code>ft_setup</code> in localStorage. Use “Preset: From Selector” in the game.</span>
      </div>
    </section>

    <section class="panel" style="grid-column: 1 / -1;">
      <h2>Queued Units</h2>
      <div class="small">Tip: If you set X/Y outside your game’s grid, the main game will clamp or auto-place them.</div>
      <div class="sep"></div>
      <div class="lists">
        <div>
          <div class="small">Allies</div>
          <div id="allyList"></div>
        </div>
        <div>
          <div class="small">Enemies</div>
          <div id="enemyList"></div>
        </div>
      </div>
    </section>
  </main>

<script src="class-data.js"></script>
<script>
const CLASS_ENTRIES = window.FABLE_DATA.CLASS_DATABASE;
const CLASS_NAMES = CLASS_ENTRIES.map(entry=>entry.name);

/* Sprite map (use your real paths if you have them) */
const SPRITES = (()=>{
  const spriteSvg = (label, primary, accent, glyph)=>{
    const id = label.replace(/[^a-z0-9]/gi,'');
    const safeGlyph = glyph || label[0] || '?';
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128">
      <defs>
        <linearGradient id="grad${id}" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="${primary}"/>
          <stop offset="100%" stop-color="${accent}"/>
        </linearGradient>
        <radialGradient id="glow${id}" cx="0.3" cy="0.2" r="0.85">
          <stop offset="0%" stop-color="rgba(255,255,255,0.45)"/>
          <stop offset="60%" stop-color="rgba(255,255,255,0.1)"/>
          <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
        </radialGradient>
      </defs>
      <rect width="128" height="128" rx="22" fill="url(#grad${id})"/>
      <rect width="128" height="128" rx="22" fill="url(#glow${id})" opacity="0.55"/>
      <circle cx="108" cy="28" r="18" fill="rgba(255,255,255,0.16)"/>
      <circle cx="32" cy="18" r="12" fill="rgba(0,0,0,0.18)"/>
      <text x="64" y="78" text-anchor="middle" font-family="'Outfit', 'Segoe UI', sans-serif" font-size="56" fill="#ffffff" opacity="0.92">${safeGlyph}</text>
      <text x="64" y="112" text-anchor="middle" font-family="'Outfit', 'Segoe UI', sans-serif" font-size="18" fill="#f8fbff" letter-spacing="1">${label}</text>
    </svg>`;
    return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
  };
  const palettes = [
    ['#3b6bff','#91b4ff'],
    ['#f97316','#facc15'],
    ['#14b8a6','#60a5fa'],
    ['#f472b6','#c084fc'],
    ['#22c55e','#a3e635'],
    ['#f87171','#fb7185'],
    ['#0ea5e9','#38bdf8'],
    ['#ef4444','#f97316'],
    ['#a855f7','#f0abfc'],
    ['#eab308','#f97316']
  ];
  const glyphs = window.FABLE_DATA.GLYPH_OVERRIDES || {};
  return Object.fromEntries(CLASS_NAMES.map((label, idx)=>{
    const [primary, accent] = palettes[idx % palettes.length];
    const glyph = glyphs[label] || label[0] || '?';
    return [label, spriteSvg(label, primary, accent, glyph)];
  }));
})();

function defaultNameFor(cls){
  return window.FABLE_DATA.defaultNameFor(cls);
}

const state = {
  gridW: 8,
  gridH: 6,
  allies: [],
  enemies: []
};

/* DOM */
const classSel = document.getElementById('classSel');
const nameInput = document.getElementById('nameInput');
const teamSel = document.getElementById('teamSel');
const xInput = document.getElementById('xInput');
const yInput = document.getElementById('yInput');
const addBtn = document.getElementById('addBtn');
const preview = document.getElementById('preview');
const classInfo = document.getElementById('classInfo');
const classFiltersEl = document.getElementById('classFilters');
const classGrid = document.getElementById('classGrid');

const gridW = document.getElementById('gridW');
const gridH = document.getElementById('gridH');
const saveBtn = document.getElementById('saveBtn');
const loadBtn = document.getElementById('loadBtn');
const clearBtn = document.getElementById('clearBtn');

const allyList = document.getElementById('allyList');
const enemyList = document.getElementById('enemyList');

const CLASS_FILTER_CONFIG = {
  all: { predicate: ()=>true },
  martial: { predicate: entry=>{
    const attune = entry.attunement || {};
    return (attune.FAE ?? 0) === 0 && (attune.DREAM ?? 0) === 0;
  } },
  fae: { predicate: entry=>{
    const attune = entry.attunement || {};
    return (attune.FAE ?? 0) > 0;
  } },
  dream: { predicate: entry=>{
    const attune = entry.attunement || {};
    return (attune.DREAM ?? 0) > 0;
  } },
  hybrid: { predicate: entry=>{
    const attune = entry.attunement || {};
    return (attune.FAE ?? 0) > 0 && (attune.DREAM ?? 0) > 0;
  } },
  combat: { predicate: entry => (entry.category || 'Combat') === 'Combat' },
  support: { predicate: entry => (entry.category || 'Combat') === 'Support' },
  utility: { predicate: entry => (entry.category || 'Combat') === 'Utility' }
};

let currentClassFilter = 'all';
let classFilterButtons = [];

/* init */
(function init(){
  classSel.innerHTML = CLASS_NAMES.map(c=>`<option value="${c}">${c}</option>`).join('');
  classSel.value = CLASS_NAMES[0] || "Knight";
  updatePreview();
  gridW.value = state.gridW; gridH.value = state.gridH;
  renderLists();
  setupClassBrowser();
})();

function setupClassBrowser(){
  if(!classFiltersEl || !classGrid) return;
  classFilterButtons = Array.from(classFiltersEl.querySelectorAll('[data-filter]'));
  classFilterButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      currentClassFilter = btn.dataset.filter || 'all';
      classFilterButtons.forEach(b=>b.classList.toggle('active', b===btn));
      renderClassGrid();
    });
  });
  renderClassGrid();
}

function renderClassGrid(){
  if(!classGrid) return;
  const predicate = (CLASS_FILTER_CONFIG[currentClassFilter] || CLASS_FILTER_CONFIG.all).predicate;
  const entries = CLASS_ENTRIES.filter(predicate).slice().sort((a,b)=>a.name.localeCompare(b.name));
  if(!entries.length){
    classGrid.innerHTML = `<div class="classGridEmpty small">No classes match this filter.</div>`;
    highlightSelectedClass();
    return;
  }
  classGrid.innerHTML = entries.map(entry=>classTileHTML(entry)).join('');
  classGrid.querySelectorAll('.classTile').forEach(tile=>{
    tile.addEventListener('click', ()=>{
      const cls = tile.dataset.class;
      if(cls){
        classSel.value = cls;
        updatePreview();
      }
    });
  });
  highlightSelectedClass();
}

function classTileHTML(entry){
  const attune = entry.attunement || {};
  const fae = attune.FAE ?? 0;
  const dream = attune.DREAM ?? 0;
  const skills = Array.isArray(entry.startingSkills) ? entry.startingSkills : [];
  const skillPreview = skills.length > 3 ? `${skills.slice(0,3).join(', ')}…` : skills.join(', ');
  const derived = window.FABLE_DATA.computeDerivedStats(entry);
  const category = entry.category || 'Combat';
  const categorySlug = category.toLowerCase();
  return `
    <div class="classTile" data-class="${entry.name}">
      <div class="thumb" style="background-image:url('${SPRITES[entry.name]||""}')"></div>
      <div class="details">
        <div class="title">${entry.name}</div>
        <div class="statsLine">HP ${derived.maxHp} • ATK ${derived.atk} • DEF ${derived.def} • SPD ${derived.spd} • RNG ${derived.range}</div>
        <div class="tagsLine">
          <span class="tag category-badge category-${categorySlug}">${category} Unit</span>
          <span class="tag">FAE ${fae}</span>
          <span class="tag">DREAM ${dream}</span>
          ${skillPreview ? `<span class="tag">Skills: ${skillPreview}</span>` : ''}
        </div>
      </div>
    </div>
  `;
}

function highlightSelectedClass(){
  if(!classGrid) return;
  classGrid.querySelectorAll('.classTile').forEach(tile=>{
    tile.classList.toggle('selected', tile.dataset.class === classSel.value);
  });
}

function updatePreview(){
  const c = classSel.value;
  preview.style.backgroundImage = `url("${SPRITES[c]||''}")`;
  if(classInfo){
    const entry = CLASS_ENTRIES.find(e=>e.name===c);
    if(entry){
      const core = entry.stats || {};
      const attune = entry.attunement || {};
      const res = entry.resources || {};
      const skills = (entry.startingSkills||[]).join(', ');
      const category = entry.category || 'Combat';
      classInfo.innerHTML = `
        <div><strong>Core:</strong> STR ${core.STR} • DEX ${core.DEX} • CON ${core.CON} • INT ${core.INT} • WIS ${core.WIS} • CHA ${core.CHA}</div>
        <div><strong>Attune:</strong> FAE ${attune.FAE ?? 0} • DREAM ${attune.DREAM ?? 0}</div>
        <div><strong>Category:</strong> ${category}</div>
        <div><strong>Vitals:</strong> HP ${res.HP ?? '-'} • EP ${res.EP ?? '-'} • AP ${res.AP ?? '-'} • MOV ${res.MOV ?? '-'}</div>
        <div><strong>Skills:</strong> ${skills}</div>
      `;
    } else {
      classInfo.textContent = '';
    }
  }
  highlightSelectedClass();
}
classSel.addEventListener('change', updatePreview);

/* Add unit */
addBtn.onclick = ()=>{
  const tpl = classSel.value;
  const name = (nameInput.value||"").trim() || defaultNameFor(tpl);
  const team = teamSel.value;
  let pos = null;

  const x = xInput.value === "" ? null : Number(xInput.value);
  const y = yInput.value === "" ? null : Number(yInput.value);
  if(Number.isFinite(x) && Number.isFinite(y) && x>=0 && y>=0) pos = {x,y};

  const unit = { tpl, name, pos };
  if(team === "ally") state.allies.push(unit); else state.enemies.push(unit);

  // clear name/x/y for faster repeated entry
  nameInput.value = ""; xInput.value=""; yInput.value="";
  renderLists();
};

/* Render queues */
function renderLists(){
  allyList.innerHTML = state.allies.map((u,i)=>cardHTML(u,"ally",i)).join('') || `<div class="small">No allies yet.</div>`;
  enemyList.innerHTML = state.enemies.map((u,i)=>cardHTML(u,"enemy",i)).join('') || `<div class="small">No enemies yet.</div>`;

  // wire delete buttons
  document.querySelectorAll('[data-del]').forEach(btn=>{
    btn.onclick = ()=>{
      const { team, idx } = btn.dataset;
      const i = Number(idx);
      if(team==="ally") state.allies.splice(i,1); else state.enemies.splice(i,1);
      renderLists();
    };
  });
}

function cardHTML(u,team,idx){
  const posLabel = u.pos ? `(${u.pos.x},${u.pos.y})` : 'auto';
  return `
    <div class="unitCard">
      <div class="sprite" style="background-image:url('${SPRITES[u.tpl]||""}')"></div>
      <div>
        <div class="name">${u.name}</div>
        <div class="meta"><span class="metaClass">${u.tpl}</span><span class="pill">${team.toUpperCase()}</span><span class="pos">POS ${posLabel}</span></div>
      </div>
      <div><button class="ghost" data-del data-team="${team}" data-idx="${idx}">Remove</button></div>
    </div>
  `;
}

/* Save / Load / Clear */
saveBtn.onclick = ()=>{
  state.gridW = clampInt(gridW.value, 8, 4, 16);
  state.gridH = clampInt(gridH.value, 6, 3, 12);

  const payload = {
    grid: { w: state.gridW, h: state.gridH }, // informational only; main game ignores/overrides if different
    allies: state.allies,
    enemies: state.enemies
  };
  localStorage.setItem('ft_setup', JSON.stringify(payload));
  alert('Saved party to localStorage as "ft_setup". In the main game, click “Preset: From Selector”.');
};

loadBtn.onclick = ()=>{
  const raw = localStorage.getItem('ft_setup');
  if(!raw){ alert('No saved ft_setup found.'); return; }
  try{
    const data = JSON.parse(raw);
    state.allies = Array.isArray(data.allies) ? data.allies : [];
    state.enemies = Array.isArray(data.enemies) ? data.enemies : [];
    if(data.grid){ gridW.value = data.grid.w ?? gridW.value; gridH.value = data.grid.h ?? gridH.value; }
    renderLists();
  }catch(e){
    alert('Could not parse ft_setup.');
  }
};

clearBtn.onclick = ()=>{
  if(!confirm('Clear allies, enemies, and remove ft_setup from localStorage?')) return;
  state.allies = [];
  state.enemies = [];
  localStorage.removeItem('ft_setup');
  renderLists();
};

/* helpers */
function clampInt(v, def, min, max){
  const n = Number(v);
  if(!Number.isFinite(n)) return def;
  return Math.max(min, Math.min(max, Math.round(n)));
}
</script>
</body>
</html>
