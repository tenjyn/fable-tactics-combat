<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fable Tactics – Setup + Grid Combat</title>
<style>
  :root { --bg:#0e0f12; --panel:#171922; --accent:#7fe6a2; --muted:#9aa3b2; --bad:#ff9b9b; --good:#8bd5ff; --ally:#7fe6a2; --enemy:#ff9b9b;}
  * { box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  body { margin:0; background:linear-gradient(180deg,#0b0c0f,#12131a); color:white; }
  header { padding:16px 20px; border-bottom:1px solid #222633; background:#12141c; position:sticky; top:0; z-index:5; }
  header h1 { margin:0; font-size:18px; letter-spacing:.5px; }
  main { max-width:1200px; margin:0 auto; padding:20px; display:grid; gap:16px;
    grid-template-columns: 1.1fr 0.9fr; grid-template-areas:
    "board side"
    "controls log"; }
  .panel { background:var(--panel); border:1px solid #24283a; border-radius:10px; padding:14px; box-shadow:0 6px 20px rgba(0,0,0,.25); }
  .board { grid-area:board; }
  .side { grid-area:side; display:grid; gap:16px; }
  .controls { grid-area:controls; display:flex; flex-wrap:wrap; gap:10px; align-items:flex-start; }
  .log { grid-area:log; max-height:320px; overflow:auto; background:#12141c; }
  h2 { margin:0 0 8px; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em; }
  .small { font-size:12px; color:var(--muted); }
  .divider { height:1px; background:#222634; margin:10px 0; }

  /* Roster & party lists */
  .unit { display:flex; align-items:center; gap:10px; padding:8px; margin:6px 0; background:#11131a; border:1px solid #1f2330; border-radius:8px; }
  .unit.dead { opacity:.45; filter:grayscale(1); }
  .badge { font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #2b3144; color:var(--muted); }
  .hpbar { width:100%; height:14px; background:#1b1f2b; border-radius:6px; overflow:hidden; border:1px solid #2a2f41; }
  .hp { height:100%; background:linear-gradient(90deg, #4ade80, #22c55e); }
  .row { display:flex; gap:10px; align-items:center; width:100%; }
  .col { flex:1; }
  .stats { font-size:12px; color:var(--muted); }
  .tag { font-size:11px; padding:1px 6px; border-radius:6px; background:#1b2230; border:1px solid #2a3347; margin-left:4px; }
  .turnbar { display:flex; gap:6px; flex-wrap:wrap; margin:10px 0 0; }
  .pill { font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #2b3144; background:#111520; opacity:.9; }
  .pill.active { border-color:var(--accent); color:var(--accent); }

  /* Buttons & inputs */
  button { background:#1c2636; color:white; border:1px solid #2b3144; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
  button:hover { border-color:#3a425d; }
  button.primary { background:#1e2e3d; border-color:#405a62; }
  button.ghost { background:transparent; border-color:#2b3144; }
  button:disabled { opacity:.5; cursor:not-allowed; }
  .btn-row { display:flex; gap:8px; flex-wrap:wrap; }
  .targetRow { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .targetBtn { padding:6px 10px; font-size:12px; border-radius:8px; background:#232a3b; border:1px solid #2f3750; }

  /* Board grid */
  .grid { display:grid; grid-template-columns: repeat(var(--w), 1fr); grid-template-rows: repeat(var(--h), 64px); gap:6px; }
  .cell { position:relative; border:1px solid #2a2f41; background:#0f1420; border-radius:8px; display:flex; align-items:center; justify-content:center; }
  .cell.coord { font-size:10px; color:#445; position:absolute; left:6px; top:4px; }
  .cell.move-ok { outline:2px dashed var(--accent); outline-offset:-4px; }
  .cell.place { outline:2px dashed #3a7; outline-offset:-4px; cursor:pointer; }
  .token { display:flex; flex-direction:column; align-items:center; gap:2px; padding:6px 8px; border-radius:10px; border:1px solid #2b3144; background:#121a26; box-shadow:0 6px 12px rgba(0,0,0,.25); }
  .token.ally { border-color:#2c4; }
  .token.enemy { border-color:#c44; }
  .token .name { font-size:12px; font-weight:700; }
  .token .hpmini { width:56px; height:6px; border-radius:4px; background:#1b1f2b; border:1px solid #2a2f41; overflow:hidden; }
  .token .hpmini > span { display:block; height:100%; background:linear-gradient(90deg,#4ade80,#22c55e); }
  .token.active { box-shadow:0 0 0 2px var(--accent), 0 8px 16px rgba(0,0,0,.35); }
  .token.inrange { box-shadow: 0 0 0 2px rgba(127,230,162,.8), 0 8px 16px rgba(0,0,0,.35); }
  .token.removable { cursor:pointer; outline:2px dashed #a55; outline-offset:-4px; }
</style>
</head>
<body>
  <header><h1>Fable Tactics • Quick Setup + Grid Combat</h1></header>
  <main>
    <section class="panel board">
      <h2 id="phaseTitle">Setup: Place Units</h2>
      <div id="board" class="grid"></div>
      <div id="boardHint" class="small" style="margin-top:8px"></div>
    </section>

    <section class="side">
      <section class="panel" id="setupPanel">
        <h2>Quick Setup</h2>
        <div class="small">Pick a build, choose a team, then click a tile to place. Click a token to remove.</div>
        <div class="divider"></div>

        <div class="btn-row" style="margin-bottom:8px">
          <label><input type="radio" name="team" value="ally" checked> Allies</label>
          <label><input type="radio" name="team" value="enemy"> Enemies</label>
        </div>

        <div class="btn-row" id="buildRow"></div>

        <div class="divider"></div>
        <div class="btn-row">
          <button id="presetBtn" class="ghost">Preset: Skirmish 2v2</button>
          <button id="fromSelectorBtn" class="ghost">Preset: From Selector</button>
          <button id="clearBtn" class="ghost">Clear Board</button>
          <button id="startBtn" class="primary">Start Battle</button>
        </div>
      </section>

      <section class="panel" id="partyPanel" style="display:none">
        <h2>Allies</h2>
        <div id="partyList"></div>
        <div class="divider"></div>
        <div>
          <div class="small">Turn Order</div>
          <div id="turnbar" class="turnbar"></div>
        </div>
      </section>

      <section class="panel" id="enemyPanel" style="display:none">
        <h2>Enemies</h2>
        <div id="enemyList"></div>
        <div class="divider"></div>
        <div class="small">Melee needs adjacency. Use <b>Move</b> first.</div>
      </section>
    </section>

    <section class="panel controls">
      <div class="col">
        <h2>Actions</h2>
        <div id="actionRow" class="btn-row">
          <button id="attackBtn" class="primary" disabled>Attack</button>
          <button id="abilityBtn" disabled>Ability</button>
          <button id="defendBtn" disabled>Defend</button>
          <button id="moveBtn" disabled>Move</button>
          <button id="endBtn" disabled>End Turn</button>
          <button id="autoBtn" title="Let the AI play for you" disabled>Auto-Play</button>
        </div>
        <div id="abilityRow" class="targetRow"></div>
        <div id="targetRow" class="targetRow"></div>
      </div>
    </section>

    <section class="panel log">
      <h2>Combat Log</h2>
      <div id="log"></div>
    </section>
  </main>

<script>
/* ========= Core helpers ========= */
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const choice=(arr)=>arr[Math.floor(Math.random()*arr.length)];
const GRID_W=6, GRID_H=4;
const dist=(a,b)=>Math.abs(a.x-b.x)+Math.abs(a.y-b.y);
const inRange=(u,t,r)=>dist(u.pos,t.pos)<=r;
const isAdjacent=(a,b)=>dist(a,b)===1;
function shortName(n){ return n.replace(/\(.*?\)/,'').trim().split(' ')[0]; }
function getUnitAt(x,y){ return G.units.find(u=>!u.dead && u.pos && u.pos.x===x && u.pos.y===y); }

/* ========= Libraries ========= */
const StatusLib={
  Guard:{name:"Guard",desc:"Increase DEF by 50% for 1 turn.",duration:1,
    apply(u){u.temp.defBonus=(u.temp.defBonus||0)+Math.ceil(u.stats.def*0.5);},
    remove(u){u.temp.defBonus=0;},tick(){}},
  Bleed:{name:"Bleed",desc:"Lose 5 HP at start for 2 turns.",duration:2,
    apply(){},remove(){},tick(u,log){const dmg=5;u.hp=clamp(u.hp-dmg,0,u.stats.maxHp);log(`${u.name} bleeds for <span class="dmg">-${dmg}</span>.`);}}
};

const AbilityLib={
  PowerStrike:{name:"Power Strike",desc:"+50% ATK single hit. 1-turn CD. (range 1)",cooldown:1,range:1,target:"enemy",
    use(user,target,log){const atk=Math.ceil(user.stats.atk*1.5);const dmg=computeDamage(atk,target.stats.def+(target.temp.defBonus||0));dealDamage(target,dmg,`${user.name} uses Power Strike on ${target.name} for <span class="dmg">-${dmg}</span>.`,log);}},
  Guard:{name:"Guard",desc:"Gain Guard for 1 turn.",cooldown:2,range:0,target:"self",
    use(user,_t,log){addStatus(user,"Guard",log);log(`${user.name} braces and gains <span class="hit">Guard</span>.`);}},
  BleedingShot:{name:"Bleeding Shot",desc:"Light hit + Bleed. (range 3)",cooldown:2,range:3,target:"enemy",
    use(user,target,log){const atk=Math.ceil(user.stats.atk*0.8);const dmg=computeDamage(atk,target.stats.def+(target.temp.defBonus||0));dealDamage(target,dmg,`${user.name} uses Bleeding Shot on ${target.name} for <span class="dmg">-${dmg}</span>.`,log);if(!target.dead){addStatus(target,"Bleed",log);log(`${target.name} is now <span class="hit">Bleeding</span>.`);}}},
  Recover:{name:"Recover",desc:"Restore 12 HP to self.",cooldown:2,range:0,target:"self",
    use(user,_t,log){const heal=12;const before=user.hp;user.hp=clamp(user.hp+heal,0,user.stats.maxHp);log(`${user.name} recovers <span class="heal">+${user.hp-before}</span> HP.`);}}
};

/* ========= Unit templates (expanded) ========= */
const UnitTemplates = {
  // melee
  Knight:      { label:"Knight",      name:"Tallis (Knight)", stats:{maxHp:60,atk:14,def:10,spd:7},  abilities:["PowerStrike","Guard"], range:1 },
  Fighter:     { label:"Fighter",     name:"Fighter",         stats:{maxHp:54,atk:13,def:9, spd:9}, abilities:["PowerStrike","Guard"], range:1 },
  Rogue:       { label:"Rogue",       name:"Rogue",           stats:{maxHp:42,atk:12,def:6, spd:13},abilities:["PowerStrike","Guard"], range:1 },
  Monk:        { label:"Monk",        name:"Monk",            stats:{maxHp:46,atk:12,def:7, spd:12},abilities:["PowerStrike","Guard"], range:1 },
  Paladin:     { label:"Paladin",     name:"Paladin",         stats:{maxHp:62,atk:13,def:11,spd:6}, abilities:["PowerStrike","Guard"], range:1 },
  Berserker:   { label:"Berserker",   name:"Berserker",       stats:{maxHp:58,atk:16,def:6, spd:8}, abilities:["PowerStrike","Guard"], range:1 },
  Spearmaster: { label:"Spearmaster", name:"Spearmaster",     stats:{maxHp:50,atk:13,def:8, spd:10},abilities:["PowerStrike","Guard"], range:1 },
  Sentinel:    { label:"Sentinel",    name:"Sentinel",        stats:{maxHp:64,atk:12,def:12,spd:5}, abilities:["PowerStrike","Guard"], range:1 },
  Duelist:     { label:"Duelist",     name:"Duelist",         stats:{maxHp:45,atk:14,def:7, spd:12},abilities:["PowerStrike","Guard"], range:1 },
  Assassin:    { label:"Assassin",    name:"Assassin",        stats:{maxHp:38,atk:15,def:5, spd:14},abilities:["PowerStrike","Guard"], range:1 },

  // ranged
  Archer:      { label:"Archer",      name:"Clover (Archer)", stats:{maxHp:44,atk:11,def:7, spd:12},abilities:["BleedingShot","Recover"], range:3 },
  Scout:       { label:"Scout",       name:"Scout",           stats:{maxHp:40,atk:10,def:6, spd:14},abilities:["BleedingShot","Recover"], range:3 },
  Hunter:      { label:"Hunter",      name:"Hunter",          stats:{maxHp:46,atk:12,def:7, spd:11},abilities:["BleedingShot","Recover"], range:3 },
  Sharpshooter:{ label:"Sharpshooter",name:"Sharpshooter",    stats:{maxHp:42,atk:14,def:6, spd:10},abilities:["BleedingShot","Recover"], range:3 },
  Slinger:     { label:"Slinger",     name:"Slinger",         stats:{maxHp:40,atk:11,def:6, spd:13},abilities:["BleedingShot","Recover"], range:3 },

  // support (placeholder kit)
  Magician:    { label:"Magician",    name:"Magician",        stats:{maxHp:40,atk:11,def:6, spd:11},abilities:["BleedingShot","Recover"], range:3 },
  Warlock:     { label:"Warlock",     name:"Warlock",         stats:{maxHp:38,atk:12,def:5, spd:10},abilities:["BleedingShot","Recover"], range:3 },
  Cleric:      { label:"Cleric",      name:"Cleric",          stats:{maxHp:46,atk:9, def:8, spd:9}, abilities:["BleedingShot","Recover"], range:3 },
  Druid:       { label:"Druid",       name:"Druid",           stats:{maxHp:44,atk:10,def:7, spd:10},abilities:["BleedingShot","Recover"], range:3 },
  Bard:        { label:"Bard",        name:"Bard",            stats:{maxHp:42,atk:9, def:7, spd:12},abilities:["BleedingShot","Recover"], range:3 },
  Shaman:      { label:"Shaman",      name:"Shaman",          stats:{maxHp:44,atk:11,def:7, spd:10},abilities:["BleedingShot","Recover"], range:3 },
  Alchemist:   { label:"Alchemist",   name:"Alchemist",       stats:{maxHp:40,atk:12,def:6, spd:11},abilities:["BleedingShot","Recover"], range:3 },
  Enchanter:   { label:"Enchanter",   name:"Enchanter",       stats:{maxHp:38,atk:10,def:6, spd:11},abilities:["BleedingShot","Recover"], range:3 },

  // enemy archetypes
  Bruiser:     { label:"Bruiser",     name:"Goblin Bruiser",  stats:{maxHp:40,atk:12,def:6, spd:8}, abilities:["PowerStrike"], range:1 },
  Imp:         { label:"Imp",         name:"Woad Imp",        stats:{maxHp:32,atk:9, def:5, spd:11},abilities:["BleedingShot"], range:3 },
};

function makeUnit(tplKey, team, pos){
  const T = UnitTemplates[tplKey] || UnitTemplates.Knight;
  return {
    id: crypto.randomUUID(),
    name: T.name, team,
    stats: {...T.stats}, hp:T.stats.maxHp, dead:false,
    temp:{defBonus:0,defend:false}, statuses:[],
    abilities: T.abilities.map(k=>({key:k,cd:0})),
    range: T.range,
    pos: pos? {...pos} : null
  };
}

/* ========= Global State ========= */
const G={ phase:"setup", units:[], acting:null, round:1, moveMode:false, auto:false };

/* ========= Math / Effects ========= */
function computeDamage(atk,def){ const base=Math.max(1, atk - Math.floor(def*0.7)); const variance=rand(-2,2); return Math.max(1, base+variance); }
function dealDamage(target,dmg,msg,log){ target.hp=clamp(target.hp-dmg,0,target.stats.maxHp); if(msg) log(msg); if(target.hp===0){ target.dead=true; log(`<b>${target.name}</b> is defeated.`);} }
function addStatus(u,key,log){ const tpl=StatusLib[key]; if(!tpl) return; const ex=u.statuses.find(s=>s.key===key); if(ex) ex.turnsLeft=tpl.duration; else u.statuses.push({key,turnsLeft:tpl.duration}); tpl.apply(u,log); }
function tickStatusesStart(u,log){ for(const s of [...u.statuses]){ const tpl=StatusLib[s.key]; if(tpl&&tpl.tick) tpl.tick(u,log); if(u.hp===0) break; } }
function cleanupStatusesEnd(u,log){ for(const s of [...u.statuses]){ s.turnsLeft-=1; if(s.turnsLeft<=0){ const tpl=StatusLib[s.key]; if(tpl&&tpl.remove) tpl.remove(u,log); u.statuses=u.statuses.filter(x=>x!==s);} } u.temp.defend=false; u.temp.defBonus=0; }

/* ========= Turn & Teams ========= */
function living(team){ return G.units.filter(u=>u.team===team && !u.dead); }
function anyLiving(team){ return living(team).length>0; }
function initiativeOrder(){ return G.units.filter(u=>!u.dead).slice().sort((a,b)=> b.stats.spd - a.stats.spd || (a.id > b.id ? 1 : -1)); }

/* ========= UI elements ========= */
const BOARD=document.getElementById('board');
const PHASE=document.getElementById('phaseTitle');
const BOARD_HINT=document.getElementById('boardHint');
const SETUP_PANEL=document.getElementById('setupPanel');
const PARTY_PANEL=document.getElementById('partyPanel');
const ENEMY_PANEL=document.getElementById('enemyPanel');

const PARTY=document.getElementById('partyList');
const ENEMIES=document.getElementById('enemyList');
const TURNBAR=document.getElementById('turnbar');
const LOG=document.getElementById('log');

const ATTACK=document.getElementById('attackBtn');
const ABILITY=document.getElementById('abilityBtn');
const DEFEND=document.getElementById('defendBtn');
const MOVE=document.getElementById('moveBtn');
const END=document.getElementById('endBtn');
const AUTO=document.getElementById('autoBtn');

const TARGETS=document.getElementById('targetRow');
const ABILROW=document.getElementById('abilityRow');

const buildRow=document.getElementById('buildRow');
const presetBtn=document.getElementById('presetBtn');
const fromSelectorBtn=document.getElementById('fromSelectorBtn');
const clearBtn=document.getElementById('clearBtn');
const startBtn=document.getElementById('startBtn');

/* ========= Setup: builds UI ========= */
let activeBuild="Knight";
function renderBuildButtons(){
  buildRow.innerHTML="";
  Object.keys(UnitTemplates).forEach(key=>{
    const b=document.createElement('button');
    b.textContent=UnitTemplates[key].label;
    b.className = key===activeBuild ? "primary" : "";
    b.onclick=()=>{ activeBuild=key; renderBuildButtons(); renderBoard(); };
    buildRow.appendChild(b);
  });
}
function getSelectedTeam(){
  const radios=[...document.querySelectorAll('input[name="team"]')];
  const r=radios.find(x=>x.checked); return r? r.value : "ally";
}

/* ========= Rendering ========= */
function log(msg){ const el=document.createElement('div'); el.className='toast'; el.innerHTML=msg; LOG.appendChild(el); LOG.scrollTop=LOG.scrollHeight; }

function render(){
  PHASE.textContent = G.phase==="setup" ? "Setup: Place Units" : "Battle";
  BOARD.style.setProperty('--w', GRID_W);
  BOARD.style.setProperty('--h', GRID_H);

  if(G.phase==="setup"){
    SETUP_PANEL.style.display="";
    PARTY_PANEL.style.display="none";
    ENEMY_PANEL.style.display="none";
    ATTACK.disabled=ABILITY.disabled=DEFEND.disabled=MOVE.disabled=END.disabled=AUTO.disabled=true;
  }else{
    SETUP_PANEL.style.display="none";
    PARTY_PANEL.style.display="";
    ENEMY_PANEL.style.display="";
    const playerTurn=G.acting && G.acting.team==='ally' && !G.acting.dead;
    ATTACK.disabled = !playerTurn;
    ABILITY.disabled = !playerTurn;
    DEFEND.disabled = !playerTurn;
    MOVE.disabled   = !playerTurn;
    END.disabled    = !playerTurn;
    AUTO.disabled   = false;
  }

  PARTY.innerHTML=''; for(const u of living('ally')) PARTY.appendChild(renderUnit(u));
  ENEMIES.innerHTML=''; for(const u of living('enemy')) ENEMIES.appendChild(renderUnit(u));

  TURNBAR.innerHTML='';
  if(G.phase==="battle"){
    for(const u of initiativeOrder()){
      const pill=document.createElement('span');
      pill.className='pill'+(G.acting&&G.acting.id===u.id?' active':'');
      pill.textContent=shortName(u.name);
      TURNBAR.appendChild(pill);
    }
  }

  renderBoard();
}

function renderUnit(u){
  const wrap=document.createElement('div');
  wrap.className='unit'+(u.dead?' dead':'');
  const side=document.createElement('div'); side.className='badge'; side.textContent=u.team==='ally'?'ALLY':'ENEMY';
  const info=document.createElement('div'); info.className='col';
  const name=document.createElement('div'); name.innerHTML=`<b>${u.name}</b>`;
  const stats=document.createElement('div'); stats.className='stats';
  const defNow=u.stats.def + (u.temp.defBonus||0) + (u.temp.defend?2:0);
  const pos
